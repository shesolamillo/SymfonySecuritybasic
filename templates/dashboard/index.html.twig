{% extends 'base.html.twig' %}

{% block title %}Dashboard{% endblock %}

{% block stylesheets %}
{{ parent() }}
<link rel="stylesheet" href="{{ asset('css/dashboard.css') }}">
{% endblock %}

{% block body %}

<div class="main-content">

    <!-- Cards Overview: Orders & Loyalty -->
    <div class="cards">
        <div class="card">Orders Today: {{ salesToday }}</div>
        <div class="card">Pending Orders: {{ pendingOrders }}</div>
        <div class="card">Completed Orders: {{ completedOrders }}</div>

        {# Loyalty info for ROLE_USER #}
        {% if is_granted('ROLE_USER') %}
            <div class="card">
                My Points: {{ myLoyalty.points|default(0) }}
                {% if myLoyalty.rewardType is defined and myLoyalty.rewardType %}
                    <br><span class="badge bg-success">{{ myLoyalty.rewardType }}</span>
                {% endif %}
            </div>
        {% endif %}

        {# Loyalty overview for ROLE_STAFF #}
        {% if is_granted('ROLE_STAFF') %}
            <div class="card">
                Total Loyalty Users: {{ totalLoyaltyUsers|default(0) }}
            </div>
        {% endif %}

        {# Admin full control #}
        {% if is_granted('ROLE_ADMIN') %}
            <div class="card">
                Admin: Full Loyalty Control
            </div>
        {% endif %}
    </div>

    <!-- Loyalty Chart for STAFF/ADMIN -->
    {% if is_granted('ROLE_STAFF') or is_granted('ROLE_ADMIN') %}
    <div class="charts">
        <div class="chart-card"><canvas id="loyaltyChart"></canvas></div>
    </div>
    {% endif %}

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
{% if loyaltyUsers is defined and loyaltyUsers|length > 0 and (is_granted('ROLE_STAFF') or is_granted('ROLE_ADMIN')) %}

const labels = [{{ loyaltyUsers|map(u => "'" ~ u.user.username ~ "'")|join(',') }}];
const points = [{{ loyaltyUsers|map(u => u.points|default(0))|join(',') }}];

new Chart(document.getElementById('loyaltyChart'), {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: 'Loyalty Points',
            data: points,
            backgroundColor: 'rgba(99,102,241,0.8)'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: { beginAtZero: true }
        }
    }
});

{% endif %}
</script>


{% endblock %}
